<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tars - Your Settings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0a0f;
      color: #ffffff;
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      padding: 40px 0;
    }

    .header h1 {
      font-size: 1.75rem;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #818cf8, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header p {
      color: #64748b;
      font-size: 0.95rem;
    }

    .user-info {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .user-details h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .user-details p {
      color: #64748b;
      font-size: 0.85rem;
    }

    .plan-badge {
      margin-left: auto;
      background: rgba(99, 102, 241, 0.2);
      color: #a5b4fc;
      padding: 6px 12px;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .plan-badge.pro {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }

    .section-title {
      font-size: 0.85rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 16px;
      padding-left: 4px;
    }

    .integrations {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 32px;
    }

    .integration-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: border-color 0.2s;
    }

    .integration-card:hover {
      border-color: rgba(255, 255, 255, 0.1);
    }

    .integration-card.connected {
      border-color: rgba(34, 197, 94, 0.3);
      background: rgba(34, 197, 94, 0.05);
    }

    .integration-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .integration-icon.google {
      background: linear-gradient(135deg, #ea4335, #fbbc04, #34a853, #4285f4);
    }

    .integration-icon.github {
      background: #1a1a2e;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .integration-icon.calendar {
      background: linear-gradient(135deg, #4285f4, #34a853);
    }

    .integration-icon.images {
      background: linear-gradient(135deg, #ff6b6b, #feca57);
    }

    .integration-info {
      flex: 1;
    }

    .integration-info h3 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .integration-info p {
      color: #64748b;
      font-size: 0.85rem;
    }

    .integration-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 6px;
    }

    .integration-status.connected {
      color: #22c55e;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #64748b;
    }

    .status-dot.connected {
      background: #22c55e;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 100px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
      display: inline-block;
    }

    .btn-connect {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }

    .btn-connect:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
    }

    .btn-disconnect {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .btn-disconnect:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .capabilities {
      margin-bottom: 32px;
    }

    .capability-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
    }

    .capability-card h4 {
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .capability-card p {
      color: #64748b;
      font-size: 0.8rem;
      padding-left: 24px;
    }

    .help-text {
      text-align: center;
      padding: 32px 0;
      color: #64748b;
      font-size: 0.9rem;
    }

    .help-text a {
      color: #818cf8;
      text-decoration: none;
    }

    /* Personality Section */
    .personality-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 32px;
    }

    .personality-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 24px;
    }

    .personality-card h3 {
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    .slider-group {
      margin-bottom: 24px;
    }

    .slider-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #94a3b8;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 8px;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.1);
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    }

    .toggle-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toggle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
    }

    .toggle-item:last-child {
      border-bottom: none;
    }

    .toggle-item input {
      display: none;
    }

    .toggle-switch {
      width: 44px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      position: relative;
      transition: background 0.2s;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
    }

    .toggle-item input:checked + .toggle-switch {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
    }

    .toggle-item input:checked + .toggle-switch::after {
      transform: translateX(20px);
    }

    .helper-text {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 12px;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px;
      color: white;
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
      margin-bottom: 16px;
    }

    textarea:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.5);
    }

    textarea::placeholder {
      color: #64748b;
    }

    .save-btn {
      width: 100%;
    }

    /* Loading state */
    .loading {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Error handling */
    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #f87171;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
    }

    /* Success message */
    .success-message {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: #22c55e;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
    }

    @media (max-width: 400px) {
      body {
        padding: 16px;
      }

      .integration-card {
        flex-wrap: wrap;
      }

      .btn {
        width: 100%;
        text-align: center;
        margin-top: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Screen (shown when no token) -->
    <div id="login-screen" style="display: none;">
      <div class="header">
        <h1>‚ú® Tars Portal</h1>
        <p>Sign in to manage your settings</p>
      </div>

      <div id="login-message"></div>

      <!-- Phone Input Step -->
      <div id="phone-step" class="personality-card">
        <h3>üì± Enter your phone number</h3>
        <p class="helper-text">We'll send you a verification code via text.</p>
        <input type="tel" id="phone-input" placeholder="+1 (555) 123-4567" 
          style="width:100%;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1.1rem;margin-bottom:16px;">
        <button class="btn btn-connect save-btn" onclick="sendCode()" id="send-code-btn">Send Code</button>
      </div>

      <!-- Verification Code Step -->
      <div id="code-step" class="personality-card" style="display: none;">
        <h3>üîê Enter verification code</h3>
        <p class="helper-text">We sent a 6-digit code to <span id="sent-to-phone"></span></p>
        <input type="text" id="code-input" placeholder="123456" maxlength="6"
          style="width:100%;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1.5rem;text-align:center;letter-spacing:8px;margin-bottom:16px;">
        <button class="btn btn-connect save-btn" onclick="verifyCode()" id="verify-btn">Verify</button>
        <p style="text-align:center;margin-top:16px;">
          <a href="#" onclick="resendCode()" id="resend-link" style="color:#818cf8;text-decoration:none;">Resend code</a>
          <span id="resend-timer" style="color:#64748b;"></span>
        </p>
        <p style="text-align:center;margin-top:8px;">
          <a href="#" onclick="backToPhone()" style="color:#64748b;text-decoration:none;">‚Üê Use different number</a>
        </p>
      </div>
    </div>

    <!-- Main Portal (shown when authenticated) -->
    <div id="main-portal" style="display: none;">
    <div class="header">
      <h1>‚ú® Tars Settings</h1>
      <p>Manage your connected accounts</p>
    </div>

    <div id="message-container"></div>

    <div class="user-info" id="user-info">
      <div class="user-avatar">üë§</div>
      <div class="user-details">
        <h3 id="user-phone">Loading...</h3>
        <p>Member since <span id="user-since">...</span></p>
      </div>
      <span class="plan-badge" id="plan-badge">Free</span>
    </div>

    <div class="section-title">Connected Accounts</div>
    
    <div class="integrations">
      <div class="integration-card" id="google-card">
        <div class="integration-icon google">G</div>
        <div class="integration-info">
          <h3>Google Account</h3>
          <p>Calendar, Gmail, Contacts</p>
          <div class="integration-status" id="google-status">
            <span class="status-dot"></span>
            <span>Not connected</span>
          </div>
        </div>
        <a href="#" class="btn btn-connect" id="google-btn" onclick="connectGoogle()">Connect</a>
      </div>

      <div class="integration-card" id="github-card">
        <div class="integration-icon github">üêô</div>
        <div class="integration-info">
          <h3>GitHub</h3>
          <p>Repositories, issues, code</p>
          <div class="integration-status" id="github-status">
            <span class="status-dot"></span>
            <span>Not connected</span>
          </div>
        </div>
        <a href="#" class="btn btn-connect" id="github-btn" onclick="connectGithub()">Connect</a>
      </div>

      <div class="integration-card" id="contacts-card">
        <div class="integration-icon" style="background: linear-gradient(135deg, #34d399, #10b981);">üì±</div>
        <div class="integration-info">
          <h3>iPhone Contacts</h3>
          <p>Search your phone contacts</p>
          <div class="integration-status" id="contacts-status">
            <span class="status-dot"></span>
            <span id="contacts-count">Not synced</span>
          </div>
        </div>
        <a href="#" class="btn btn-connect" id="contacts-btn" onclick="syncContacts()">Sync</a>
      </div>
    </div>

    <div class="section-title">Customize Tars</div>
    
    <div class="personality-section">
      <div class="personality-card">
        <h3>üé≠ Personality</h3>
        
        <div class="slider-group">
          <label>Communication Style</label>
          <div class="slider-labels">
            <span>Casual</span>
            <span>Formal</span>
          </div>
          <input type="range" min="0" max="100" value="30" class="slider" id="formality-slider">
        </div>
        
        <div class="slider-group">
          <label>Response Length</label>
          <div class="slider-labels">
            <span>Concise</span>
            <span>Detailed</span>
          </div>
          <input type="range" min="0" max="100" value="50" class="slider" id="length-slider">
        </div>
        
        <div class="toggle-group">
          <label class="toggle-item">
            <span>Use emojis üòä</span>
            <input type="checkbox" id="emoji-toggle" checked>
            <span class="toggle-switch"></span>
          </label>
          
          <label class="toggle-item">
            <span>Remember my name</span>
            <input type="checkbox" id="name-toggle" checked>
            <span class="toggle-switch"></span>
          </label>
          
          <label class="toggle-item">
            <span>Proactive suggestions</span>
            <input type="checkbox" id="proactive-toggle">
            <span class="toggle-switch"></span>
          </label>
        </div>
      </div>
      
      <div class="personality-card">
        <h3>üìù Custom Instructions</h3>
        <p class="helper-text">Tell Tars anything specific about how you want it to behave:</p>
        <textarea id="custom-instructions" placeholder="e.g., 'Call me Chief', 'I'm a software developer', 'Always give me options before making decisions'..."></textarea>
        <button class="btn btn-primary save-btn" onclick="savePersonality()">Save Preferences</button>
      </div>
    </div>

    <div class="section-title">What Tars Can Do</div>
    
    <div class="capabilities">
      <div class="capability-card">
        <h4>üìÖ Calendar</h4>
        <p>"What's on my calendar today?" ‚Ä¢ "Schedule a meeting for tomorrow at 2pm"</p>
      </div>
      <div class="capability-card">
        <h4>üìß Email</h4>
        <p>"Check my unread emails" ‚Ä¢ "Draft a reply to John's email"</p>
      </div>
      <div class="capability-card">
        <h4>üé® Images</h4>
        <p>"Generate an image of..." ‚Ä¢ Send any photo for analysis</p>
      </div>
      <div class="capability-card">
        <h4>üíª Coding</h4>
        <p>"Build me a script that..." ‚Ä¢ "Explain this code"</p>
      </div>
      <div class="capability-card">
        <h4>üí¨ Chat</h4>
        <p>Ask anything! Tars remembers your conversation.</p>
      </div>
    </div>

    <div class="help-text">
      Need help? Just text <strong>"help"</strong> to Tars.<br>
      <a href="/">‚Üê Back to home</a>
    </div>
    </div><!-- end main-portal -->
  </div>

  <script>
    // Get token from URL or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    let token = urlParams.get('token') || localStorage.getItem('tars_token');
    let currentPhone = localStorage.getItem('tars_phone');
    const message = urlParams.get('message');
    const authBase = "https://crystal-rainbow-donors-spin.trycloudflare.com"; // Auth server via tunnel
    const apiBase = "http://62.210.193.63:3001";
    
    let resendTimer = null;
    let resendSeconds = 0;

    // Show message if present
    if (message) {
      const container = document.getElementById('message-container');
      const isError = urlParams.get('error') === 'true';
      container.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${decodeURIComponent(message)}</div>`;
    }

    // Load user data
    async function loadUserData() {
      if (!token) {
        document.getElementById('user-phone').textContent = 'Invalid link';
        return;
      }

      try {
        const response = await fetch(`${apiBase}/api/portal/user?token=${token}`);
        const data = await response.json();

        if (data.error) {
          document.getElementById('user-phone').textContent = 'Link expired';
          return;
        }

        // Update user info
        document.getElementById('user-phone').textContent = formatPhone(data.phone);
        document.getElementById('user-since').textContent = formatDate(data.created_at);
        
        const badge = document.getElementById('plan-badge');
        if (data.subscription === 'pro') {
          badge.textContent = 'Pro';
          badge.classList.add('pro');
        } else {
          badge.textContent = 'Free';
        }

        // Update integrations
        updateIntegrationStatus('google', data.integrations?.google);
        updateIntegrationStatus('github', data.integrations?.github);

      } catch (err) {
        console.error('Failed to load user data:', err);
        document.getElementById('user-phone').textContent = 'Error loading data';
      }
    }

    function updateIntegrationStatus(service, integration) {
      const card = document.getElementById(`${service}-card`);
      const status = document.getElementById(`${service}-status`);
      const btn = document.getElementById(`${service}-btn`);

      if (integration?.connected) {
        card.classList.add('connected');
        status.classList.add('connected');
        status.innerHTML = `<span class="status-dot connected"></span><span>Connected${integration.email ? ` as ${integration.email}` : ''}</span>`;
        btn.textContent = 'Disconnect';
        btn.className = 'btn btn-disconnect';
        btn.onclick = () => disconnect(service);
      } else {
        card.classList.remove('connected');
        status.classList.remove('connected');
        status.innerHTML = `<span class="status-dot"></span><span>Not connected</span>`;
        btn.textContent = 'Connect';
        btn.className = 'btn btn-connect';
        btn.onclick = () => connect(service);
      }
    }

    function connect(service) {
      window.location.href = `${apiBase}/api/portal/connect/${service}?token=${token}`;
    }

    function disconnect(service) {
      if (confirm(`Disconnect ${service}? Tars won't be able to access your ${service} data anymore.`)) {
        window.location.href = `${apiBase}/api/portal/disconnect/${service}?token=${token}`;
      }
    }

    function connectGoogle() { connect('google'); }
    function connectGithub() { connect('github'); }

    // iPhone Contacts sync via iOS Shortcut
    async function syncContacts() {
      try {
        const response = await fetch(`${apiBase}/api/portal/contacts/shortcut?token=${token}`);
        const data = await response.json();
        
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }

        // Create and show modal with instructions
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px;';
        modal.innerHTML = `
          <div style="background:#1a1a2e;border-radius:16px;padding:24px;max-width:400px;width:100%;">
            <h3 style="margin-bottom:16px;font-size:1.2rem;">üì± Sync iPhone Contacts</h3>
            <p style="color:#94a3b8;margin-bottom:16px;font-size:0.9rem;">To sync your contacts, create an iOS Shortcut:</p>
            <ol style="color:#94a3b8;font-size:0.85rem;padding-left:20px;margin-bottom:20px;">
              <li style="margin-bottom:8px;">Open <strong>Shortcuts</strong> app on iPhone</li>
              <li style="margin-bottom:8px;">Tap <strong>+</strong> to create new shortcut</li>
              <li style="margin-bottom:8px;">Add action: <strong>"Find All Contacts"</strong></li>
              <li style="margin-bottom:8px;">Add action: <strong>"Repeat with Each"</strong></li>
              <li style="margin-bottom:8px;">Inside repeat: Add <strong>"Get Details of Contact"</strong> (Name, Phone, Email)</li>
              <li style="margin-bottom:8px;">Add <strong>"Add to Variable"</strong> (name it "contacts")</li>
              <li style="margin-bottom:8px;">After repeat: Add <strong>"Get Contents of URL"</strong></li>
              <li style="margin-bottom:8px;">Set URL to: <code style="background:#0a0a0f;padding:2px 6px;border-radius:4px;font-size:0.75rem;">${data.uploadUrl}</code></li>
              <li style="margin-bottom:8px;">Method: POST, Body: JSON with {"contacts": Variable}</li>
              <li>Run the shortcut!</li>
            </ol>
            <div style="display:flex;gap:12px;">
              <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:white;cursor:pointer;">Close</button>
              <button onclick="copyUploadUrl('${data.uploadUrl}')" style="flex:1;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;cursor:pointer;">Copy URL</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      } catch (err) {
        console.error('Sync contacts error:', err);
        alert('Failed to get sync instructions');
      }
    }

    function copyUploadUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('URL copied! Paste it in your iOS Shortcut.');
      });
    }

    async function loadContactsStatus() {
      try {
        const response = await fetch(`${apiBase}/api/portal/contacts/status?token=${token}`);
        const data = await response.json();
        
        const card = document.getElementById('contacts-card');
        const status = document.getElementById('contacts-status');
        const countSpan = document.getElementById('contacts-count');
        const btn = document.getElementById('contacts-btn');
        
        if (data.synced && data.count > 0) {
          card.classList.add('connected');
          status.classList.add('connected');
          countSpan.textContent = `${data.count} contacts synced`;
          btn.textContent = 'Re-sync';
        } else {
          countSpan.textContent = 'Not synced';
        }
      } catch (err) {
        console.error('Load contacts status error:', err);
      }
    }

    function formatPhone(phone) {
      if (!phone) return 'Unknown';
      // Format: +1 (407) 620-3717
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 11 && cleaned[0] === '1') {
        return `+1 (${cleaned.slice(1,4)}) ${cleaned.slice(4,7)}-${cleaned.slice(7)}`;
      }
      return phone;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    }

    // Save personality preferences
    async function savePersonality() {
      const preferences = {
        formality: document.getElementById('formality-slider').value,
        responseLength: document.getElementById('length-slider').value,
        useEmojis: document.getElementById('emoji-toggle').checked,
        rememberName: document.getElementById('name-toggle').checked,
        proactiveSuggestions: document.getElementById('proactive-toggle').checked,
        customInstructions: document.getElementById('custom-instructions').value
      };

      try {
        const response = await fetch(`${apiBase}/api/portal/preferences?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preferences)
        });

        if (response.ok) {
          alert('Preferences saved! ‚ú®');
        } else {
          alert('Failed to save preferences');
        }
      } catch (err) {
        console.error('Save error:', err);
        alert('Failed to save preferences');
      }
    }

    // Load personality preferences
    async function loadPreferences() {
      try {
        const response = await fetch(`${apiBase}/api/portal/preferences?token=${token}`);
        if (response.ok) {
          const prefs = await response.json();
          if (prefs.formality) document.getElementById('formality-slider').value = prefs.formality;
          if (prefs.responseLength) document.getElementById('length-slider').value = prefs.responseLength;
          if (prefs.useEmojis !== undefined) document.getElementById('emoji-toggle').checked = prefs.useEmojis;
          if (prefs.rememberName !== undefined) document.getElementById('name-toggle').checked = prefs.rememberName;
          if (prefs.proactiveSuggestions !== undefined) document.getElementById('proactive-toggle').checked = prefs.proactiveSuggestions;
          if (prefs.customInstructions) document.getElementById('custom-instructions').value = prefs.customInstructions;
        }
      } catch (err) {
        console.error('Load preferences error:', err);
      }
    }

    // ========== LOGIN FLOW ==========
    
    function showLogin() {
      document.getElementById('login-screen').style.display = 'block';
      document.getElementById('main-portal').style.display = 'none';
    }
    
    function showPortal() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-portal').style.display = 'block';
    }
    
    function showLoginMessage(msg, isError = false) {
      const container = document.getElementById('login-message');
      container.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${msg}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }
    
    async function sendCode() {
      const phoneInput = document.getElementById('phone-input');
      const btn = document.getElementById('send-code-btn');
      const phone = phoneInput.value.trim();
      
      if (!phone || phone.length < 10) {
        showLoginMessage('Please enter a valid phone number', true);
        return;
      }
      
      btn.textContent = 'Sending...';
      btn.disabled = true;
      
      try {
        const response = await fetch(`${authBase}/send-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });
        
        const data = await response.json();
        
        if (data.success) {
          currentPhone = phone;
          localStorage.setItem('tars_phone', phone);
          document.getElementById('sent-to-phone').textContent = phone;
          document.getElementById('phone-step').style.display = 'none';
          document.getElementById('code-step').style.display = 'block';
          document.getElementById('code-input').focus();
          startResendTimer(data.resendAvailableIn || 30);
        } else {
          showLoginMessage(data.error || 'Failed to send code', true);
        }
      } catch (err) {
        console.error('Send code error:', err);
        showLoginMessage('Network error. Please try again.', true);
      } finally {
        btn.textContent = 'Send Code';
        btn.disabled = false;
      }
    }
    
    async function verifyCode() {
      const codeInput = document.getElementById('code-input');
      const btn = document.getElementById('verify-btn');
      const code = codeInput.value.trim();
      
      if (!code || code.length !== 6) {
        showLoginMessage('Please enter the 6-digit code', true);
        return;
      }
      
      btn.textContent = 'Verifying...';
      btn.disabled = true;
      
      try {
        const response = await fetch(`${authBase}/verify-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentPhone, code })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Store phone as token (simplified auth)
          token = data.phone;
          currentPhone = data.phone;
          localStorage.setItem('tars_token', data.phone);
          localStorage.setItem('tars_phone', data.phone);
          
          showPortal();
          loadUserData();
          loadPreferences();
          loadContactsStatus();
        } else {
          showLoginMessage(data.error || 'Invalid code', true);
          if (data.noCode || data.expired) {
            backToPhone();
          }
        }
      } catch (err) {
        console.error('Verify error:', err);
        showLoginMessage('Network error. Please try again.', true);
      } finally {
        btn.textContent = 'Verify';
        btn.disabled = false;
      }
    }
    
    function startResendTimer(seconds) {
      resendSeconds = seconds;
      const link = document.getElementById('resend-link');
      const timer = document.getElementById('resend-timer');
      
      link.style.display = 'none';
      timer.style.display = 'inline';
      
      function updateTimer() {
        if (resendSeconds > 0) {
          timer.textContent = `(wait ${resendSeconds}s)`;
          resendSeconds--;
          resendTimer = setTimeout(updateTimer, 1000);
        } else {
          timer.style.display = 'none';
          link.style.display = 'inline';
        }
      }
      updateTimer();
    }
    
    async function resendCode() {
      if (resendSeconds > 0) return;
      await sendCodeToPhone(currentPhone);
    }
    
    async function sendCodeToPhone(phone) {
      try {
        const response = await fetch(`${authBase}/send-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });
        const data = await response.json();
        if (data.success) {
          showLoginMessage('New code sent!');
          startResendTimer(data.resendAvailableIn || 30);
        } else {
          showLoginMessage(data.error || 'Failed to resend', true);
        }
      } catch (err) {
        showLoginMessage('Network error', true);
      }
    }
    
    function backToPhone() {
      document.getElementById('phone-step').style.display = 'block';
      document.getElementById('code-step').style.display = 'none';
      document.getElementById('code-input').value = '';
      if (resendTimer) clearTimeout(resendTimer);
    }
    
    // Handle Enter key
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        if (document.getElementById('phone-step').style.display !== 'none') {
          sendCode();
        } else if (document.getElementById('code-step').style.display !== 'none') {
          verifyCode();
        }
      }
    });
    
    // ========== INITIALIZATION ==========
    
    // Check for Google OAuth callback
    if (urlParams.get('google') === 'connected') {
      const email = urlParams.get('email');
      setTimeout(() => {
        alert(`Google connected${email ? ` as ${email}` : ''}! ‚ú®`);
      }, 500);
    }
    
    // Initialize page
    if (token && token.startsWith('+')) {
      // We have a phone token, show portal
      showPortal();
      loadUserData();
      loadPreferences();
      loadContactsStatus();
    } else {
      // No token, show login
      showLogin();
      // Pre-fill phone if we have it
      if (currentPhone) {
        document.getElementById('phone-input').value = currentPhone;
      }
    }
  </script>
</body>
</html>
